<!DOCTYPE html>
<html lang='en'>

<head>
  <title>GBG CAR</title>
</head>

<body>
  <p>Use the buttons below to turn the car's joystick on and off.</p>
  <button onclick='activate();' style='font-size: 100px;'>GO</button>
  <button onclick='fetch("/deactivate");' style='font-size: 200px; float: right;'>STOP</button>
  <br>
  <div style="font-size: 50px;">status:</div>
  <div id="status" style="font-size: 50px;">loading</div>
  <br>
  <br>
  <div style="font-size: x-large;">remote override mode</div>
  <input type="radio" id="ctl-car" name="remote-mode" value="0" checked onclick='sendRemoteMode(0);' />
  <label for="ctl-car" style="font-size: x-large;">car has control</label>
  <br>
  <input type="radio" id="ctl-remote" name="remote-mode" value="1" onclick='sendRemoteMode(1);' />
  <label for="ctl-remote" style="font-size: x-large;">remote has control</label>
  <br>
  <br>
  <input type="checkbox" id='timeout' onclick='sendTimeout();'></input>
  <label for="timeout" style="font-size: larger;">deactivate if signal lost</label>

  <div id="joyDiv"
    style="width:500px;height:500px;margin-left:100%;margin-right:200px;margin-bottom:20px;margin-top:20px;float:right;">
    <canvas id="ds-canvas" width="500" height="500"></canvas>
  </div>

  <div id="telem-div">
    <table style="border:1px solid">
      <tr>
        <td>joystick left/right:</td>
        <td>joystick down/up:</td>
        <td>left motor:</td>
        <td>right motor:</td>
      </tr>
      <tr>
        <td id="telem-x">0</td>
        <td id="telem-y">0</td>
        <td id="telem-l">0</td>
        <td id="telem-r">0</td>
      </tr>
    </table>
  </div>
  <details>
    <summary> <b>Edit Settings</b> <br> <span style="background: yellow;">&#9888;</span>
      Do not edit settings with a kid in the car! Editing settings can cause
      the car to move uncontrollably which could cause harm. Test the car after making changes and remember that the
      main power switch on the car is the most reliable way to stop the car. </summary>
    <div>
      <button id="load-settings-button" onclick="loadSettings();" style="font-size: large;">Load Settings</button>
      <button id="save-settings-button" onclick="saveSettings();" style="font-size: large;">Save Settings</button>
      <button onclick="saveSettingsToFile();">save settings to file</button>
      <button id='recall-settings-button' onclick="recallSettingsFromFile();">load settings from file<span
          id='recall-stats'></span></button>
      <table id="car-settings">
      </table>
    </div>

</body>
<script>
  /*comments must be like this never with two slashes*/
  function processValue(name, value) {
    if (value === true || value === false) {
      val = value ? 1 : 0;
    } else {
      val = String(value);
    }
    if (name.slice(0, -2) == "DRIVE_BUTTON") {
      val = name.substring(name.lastIndexOf("_") + 1) + '_' + val.replaceAll(',', '_');
      name = 'DRIVE_BUTTONS';
    }
    return [name, val];
  }
  function settingsChange(name, value) {
    [name, value] = processValue(name, value);
    try {
      document.getElementById("load-settings-button").style.backgroundColor = "orange";
      fetch("/setSetting?setData=" + name + ":" + value + ",").then(response => response.status).then(data => {
        if (data == 200) {
          document.getElementById("save-settings-button").style.backgroundColor = "yellow";
          loadSettings();
        } else {
          document.getElementById("load-settings-button").style.backgroundColor = "yellow";
        }
      });
    } catch (e) {
      document.getElementById("load-settings-button").style.backgroundColor = "yellow";
    }
  }

  function saveSettings() {
    document.getElementById("save-settings-button").style.backgroundColor = "orange";
    try {
      fetch('/setSetting?setData="SAVE,"').then(response => response.status).then(data => {
        if (data == 200) {
          document.getElementById("save-settings-button").style.backgroundColor = "lightgreen";
        } else {
          document.getElementById("save-settings-button").style.backgroundColor = "red";
        }
      });
    } catch (e) {
      document.getElementById("save-settings-button").style.backgroundColor = "red";
    }
  }

  async function loadSettings() {
    var list = document.getElementById("car-settings");
    list.innerHTML = "";
    document.getElementById("load-settings-button").style.backgroundColor = "orange";
    try {
      response = await fetch('/settings');
      settings = await response.json();
      document.getElementById("load-settings-button").style.backgroundColor = "";
    } catch (e) {
      document.getElementById("load-settings-button").style.backgroundColor = "red";
      return;
    }
    for (const setting in settings) {
      if (setting == "current settings, version:") {
        continue;
      }
      var row = document.createElement("tr");
      var name = document.createElement("td");
      name.innerHTML = setting;
      row.appendChild(name);
      var valElem = document.createElement("td");
      if (settings[setting] === true || settings[setting] === false) {
        var inputElem = document.createElement("input");
        inputElem.type = "checkbox";
        if (settings[setting] === true) {
          inputElem.checked = true;
        }
        inputElem.onchange = function () { settingsChange(setting, this.value); };
        valElem.appendChild(inputElem);
      } else {
        var inputElem = document.createElement("input");
        inputElem.type = "text";
        inputElem.maxLength = 7;
        inputElem.inputMode = "decimal";
        inputElem.value = settings[setting];
        inputElem.onchange = function () { settingsChange(setting, this.value); };
        valElem.appendChild(inputElem);
      }
      row.appendChild(valElem);
      list.appendChild(row);
    }
  }

  async function saveSettingsToFile() {
    responseV = await fetch('/settings');
    settingsV = await responseV.json();
    delete settingsV["current settings, version:"];
    var resultString = '{"gbg settings backup, version": 10,';
    resultString += JSON.stringify(settingsV, null, 2).slice(1);
    downloadFile(resultString, "gbg car config.txt");
  }

  function downloadFile(input, fileName) {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(new Blob([input]));
    link.download = fileName;
    document.body.append(link);
    link.click();
    link.remove();
  };

  function sleep(sec) {
    return new Promise(resolve => setTimeout(resolve, sec * 1000.0));
  }

  async function recallSettingsFromFile() {
    document.getElementById("recall-settings-button").style.backgroundColor = "";
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.txt';
    input.onchange = async e => {
      const file = e.target.files[0];
      if (!file) {
        return;
      }
      const text = await file.text();
      let parsed;
      try {
        parsed = JSON.parse(text);
      } catch (e) {
        console.log("Error parsing JSON: " + e.message);
        return;
      }
      if (parsed["gbg settings backup, version"] !== 10) {
        console.log("Unsupported settings version");
        return;
      }
      delete parsed["gbg settings backup, version"];
      num = 0;
      document.getElementById(recall - settings - button).style.backgroundColor = "aqua";
      for (const setting in parsed) {
        document.getElementById('recall-stats').innerHTML = ' [' + Math.round(num / Object.keys(parsed).length * 100) + '%]';
        num++;
        [name, valueToSend] = processValue(setting, parsed[setting]);
        try {
          const response = await fetch('/setSetting?setData=' + name + ":" + valueToSend + ",");
          if (response.status !== 200) {
            console.log("error setting " + name);
            document.getElementById("recall-settings-button").style.backgroundColor = "yellow";
          }
          await sleep(0.1);
        } catch (e) {
          console.log("error setting " + name);
          document.getElementById("recall-settings-button").style.backgroundColor = "yellow";
          await sleep(0.15);
        }
      }
      loadSettings();
      if (document.getElementById("recall-settings-button").style.backgroundColor != "yellow") {
        document.getElementById("recall-settings-button").style.backgroundColor = "";
      }
      document.getElementById('recall-stats').innerHTML = ' [loaded]';
      document.getElementById("save-settings-button").style.backgroundColor = "yellow";
    };
    input.click();
  }

  class DSItemJoystick {
    /*inspired by github.com/RCMgames/RCMv3*/
    constructor(_dsCanvas) {
      this.dsCanvas = _dsCanvas;
      this.radius = 50;

      this.joyx = 0;
      this.joyy = 0;

      this.mousePressed = false;

      this.onMouseDownBound = this.onMouseDown.bind(this);
      this.onMouseUpBound = this.onMouseUp.bind(this);
      this.onMouseMoveBound = this.onMouseMove.bind(this);
      this.onTouchStartBound = this.onTouchStart.bind(this);
      this.onTouchEndBound = this.onTouchEnd.bind(this);
      this.onTouchMoveBound = this.onTouchMove.bind(this);

      document.addEventListener('mousedown', this.onMouseDownBound);
      document.addEventListener('mouseup', this.onMouseUpBound);
      document.addEventListener('mousemove', this.onMouseMoveBound);
      document.addEventListener('touchstart', this.onTouchStartBound);
      document.addEventListener('touchend', this.onTouchEndBound);
      document.addEventListener('touchmove', this.onTouchMoveBound, { passive: false });

      this.draw();
    }

    onMouseDown(event) {
      const rect = this.dsCanvas.getBoundingClientRect();
      const mouseX = event.clientX - rect.left;
      const mouseY = event.clientY - rect.top;
      if (mouseX >= 0 && mouseX <= this.dsCanvas.width && mouseY >= 0 && mouseY <= this.dsCanvas.height) {
        this.offsetX = mouseX;
        this.offsetY = mouseY;
        this.mousePressed = true;
        this.onMove(event.clientX, event.clientY);
        this.draw();
      }
    }
    onTouchStart(event) {
      const rect = this.dsCanvas.getBoundingClientRect();
      for (let i = 0; i < event.touches.length; i++) {
        const touch = event.touches[i];
        const mouseX = touch.clientX - rect.left;
        const mouseY = touch.clientY - rect.top;
        if (mouseX >= 0 && mouseX <= this.dsCanvas.width && mouseY >= 0 && mouseY <= this.dsCanvas.height) {
          this.offsetX = mouseX;
          this.offsetY = mouseY;
          this.mousePressed = true;
          this.activeTouchId = touch.identifier;
          this.onMove(touch.clientX, touch.clientY);
          this.draw();
        }
      }
    }
    onMouseUp() {
      this.mousePressed = false;
      this.draw();
    }
    onMouseMove(event) {
      this.onMove(event.clientX, event.clientY);
    }
    onMove(x, y) {
      if (this.mousePressed) {
        const rect = this.dsCanvas.getBoundingClientRect();
        this.joyx = (x - rect.left - this.dsCanvas.width / 2) / (this.dsCanvas.width / 2 - this.radius);
        this.joyy = -(y - rect.top - this.dsCanvas.height / 2) / (this.dsCanvas.height / 2 - this.radius);
        if (this.joyx > 1) this.joyx = 1;
        if (this.joyx < -1) this.joyx = -1;
        if (this.joyy > 1) this.joyy = 1;
        if (this.joyy < -1) this.joyy = -1;
        this.draw();
      }
    }
    onTouchEnd(event) {
      for (let i = 0; i < event.changedTouches.length; i++) {
        const touch = event.changedTouches[i];
        if (touch.identifier == this.activeTouchId) {
          this.mousePressed = false;
          this.activeTouchId = null;
          this.draw();
          break;
        }
      }
    }
    onTouchMove(event) {
      if (this.mousePressed) {
        event.preventDefault();
      }
      for (let i = 0; i < event.touches.length; i++) {
        const touch = event.touches[i];
        if (touch.identifier == this.activeTouchId) {
          this.onMove(touch.clientX, touch.clientY);
          break;
        }
      }
    }

    draw() {
      const ctx = this.dsCanvas.getContext('2d');
      ctx.beginPath();

      ctx.fillStyle = "#88FF99";

      ctx.roundRect(0, 0, this.dsCanvas.width, this.dsCanvas.height, [this.radius]);
      ctx.fill();

      ctx.beginPath();
      ctx.fillStyle = 'black';
      ctx.arc(this.dsCanvas.width / 2 + this.joyx * (this.dsCanvas.width / 2 - this.radius), this.dsCanvas.height / 2 - this.joyy * (this.dsCanvas.height / 2 - this.radius), this.radius, 0, 2 * Math.PI);
      ctx.fill();
    }

    run() {
      if (!this.mousePressed) {
        this.joyx = 0;
        this.joyy = 0;
      }
      this.draw();
    }

    GetX() {
      return Math.round(this.joyx * 100) / 100;
    }

    GetY() {
      return Math.round(this.joyy * 100) / 100;
    }

  }

  var joystick = new DSItemJoystick(document.getElementById("ds-canvas"));
  var key = 0;
  fetch('/key').then(response => response.text()).then(data => {
    key = parseInt(data);
  });
  loadSettings();
  setInterval(loop, 250);

  async function loop() {
    joystick.run();
    var remoteData = "?fb=" + joystick.GetY() + "&lr=" + joystick.GetX() + "&key=" + key;
    let errorTimeout;
    let abortcontroller = new AbortController();
    errorTimeout = setTimeout(() => {
      abortcontroller.abort("timeout");
    }, 200);

    try {
      var fetched = await fetch('/status' + remoteData, { signal: abortcontroller.signal });
      fetchedResponse = await fetched.json();

      let radios = document.getElementsByName("remote-mode");
      let value = parseInt(fetchedResponse["m"]);

      for (let i = 0, length = radios.length; i < length; i++) {
        radios[i].checked = parseInt(radios[i].value) === value;
      }

      if (value === 0) {/*modes that give a choice about deactivate when timeout*/
        document.getElementById("timeout").disabled = false;
      } else {
        document.getElementById("timeout").disabled = true;
      }

      document.getElementById("timeout").checked = fetchedResponse["d"] == 1;

      if (fetchedResponse["j"] == 1) {
        document.getElementById("status").innerHTML = (fetchedResponse["a"] == 1 ? "on" : "off");
      } else {
        document.getElementById("status").innerHTML = "center car joystick to start car";
      }

      if (fetchedResponse["k"] != key) {
        document.getElementById("status").innerHTML = "reload page";
      }

      document.getElementById("telem-x").innerHTML = fetchedResponse["x"];
      document.getElementById("telem-y").innerHTML = fetchedResponse["y"];
      document.getElementById("telem-l").innerHTML = fetchedResponse["l"];
      document.getElementById("telem-r").innerHTML = fetchedResponse["r"];

    } catch (e) {
      document.getElementById("status").innerHTML = "Disconnected";
    }
    clearTimeout(errorTimeout);
  }

  function sendTimeout() {
    if (document.getElementById("timeout").checked) {
      fetch("/timeoutOn?key=" + key);
    } else {
      fetch("/timeoutOff?key=" + key);
    }
  }

  function sendRemoteMode(mode) {
    fetch("/remoteMode?mode=" + mode + "&key=" + key);
  }

  function activate() {
    fetch("/activate?key=" + key);
  }

</script>

</html>